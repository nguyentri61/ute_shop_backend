generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "mysql"
  url      = env("DATABASE_URL")
}

enum OrderStatus {
  NEW             // đơn hàng mới (vừa đặt)
  CONFIRMED       // đã xác nhận (thủ công hoặc tự động 30 phút sau)
  PREPARING       // shop đang chuẩn bị hàng (bước 3)
  SHIPPING        // đang giao hàng
  DELIVERED       // đã giao thành công
  CANCELLED       // đã hủy
  CANCEL_REQUEST  // yêu cầu hủy gửi tới shop (khi ở PREPARING mà user muốn hủy)
}

model category {
  id        String    @id @default(uuid())
  name      String
  icon      String?
  createdAt DateTime  @default(now())
  product   product[]
}

model order {
  id        String    @id @default(uuid())
  userId    String
  address   String
  phone     String
  createdAt DateTime  @default(now())
  total     Float     @default(0)
  status    OrderStatus @default(NEW)

  user  user        @relation(fields: [userId], references: [id])
  items orderItem[]
}

model orderItem {
  id         String @id @default(uuid())
  orderId    String @map("order_id")
  variantId  String 
  quantity   Int
  price      Float @default(0)

  order    order    @relation(fields: [orderId], references: [id])
  variant  productVariant @relation(fields: [variantId], references: [id])

  @@index([orderId])
  @@index([variantId])

}

model product {
  id            String           @id @default(uuid())
  name          String
  description   String?
  price         Float
  discountPrice Float?
  stock         Int
  viewCount     Int              @default(0)
  createdAt     DateTime         @default(now())
  categoryId    String
  category      category         @relation(fields: [categoryId], references: [id], map: "Product_categoryId_fkey")
  productImage  productImage[]
  variants      productVariant[]

  @@index([categoryId], map: "Product_categoryId_fkey")
}

model productImage {
  id        String  @id @default(uuid())
  url       String
  productId String
  product   product @relation(fields: [productId], references: [id], map: "ProductImage_productId_fkey")

  @@index([productId], map: "ProductImage_productId_fkey")
}

model productVariant {
  id            String  @id @default(uuid())
  productId     String
  color         String?
  size          String?
  stock         Int
  price         Float
  discountPrice Float?

  product   product    @relation(fields: [productId], references: [id])
  cartItems cartItem[]
  orderItems orderItem[]

  @@index([productId])
}

model cartItem {
  id        String   @id @default(uuid())
  userId    String
  variantId String
  quantity  Int      @default(1)
  createdAt DateTime @default(now())

  user      user           @relation(fields: [userId], references: [id])
  variant   productVariant @relation(fields: [variantId], references: [id])

  @@unique([userId, variantId]) // 1 user chỉ có 1 cartItem cho 1 variant
  @@index([userId])
  @@index([variantId])

}

enum UserRole {
  USER
  ADMIN
}

model user {
  id        String    @id @default(uuid())
  email     String    @unique(map: "User_email_key")
  password  String
  otp       String?
  otpExpiry DateTime?
  verified  Boolean   @default(false)
  createdAt DateTime  @default(now())
  address   String?
  fullName  String?
  gender    String?
  phone     String?
  role      UserRole  @default(USER)

  orders order[]
  cart   cartItem[]
}
